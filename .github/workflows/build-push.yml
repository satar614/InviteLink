name: Build and Push to ACR

on:
  push:
    branches:
      - main
      - 'feature/**'
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/build-push.yml'
      - '.github/workflows/build.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/build-push.yml'
      - '.github/workflows/build.yml'
  workflow_call:
    inputs:
      namespace:
        required: true
        type: string
        description: 'Target namespace (main or pr-*)'
      force_backend:
        required: false
        type: boolean
        default: false
        description: 'Force build backend even if no changes'
      force_frontend:
        required: false
        type: boolean
        default: false
        description: 'Force build frontend even if no changes'
    outputs:
      backend_image:
        value: ${{ jobs.push-backend.outputs.image_uri }}
        description: 'Backend Docker image URI'
      frontend_image:
        value: ${{ jobs.push-frontend.outputs.image_uri }}
        description: 'Frontend Docker image URI'
      backend_built:
        value: ${{ jobs.detect.outputs.backend_changed }}
        description: 'Whether backend was built'
      frontend_built:
        value: ${{ jobs.detect.outputs.frontend_changed }}
        description: 'Whether frontend was built'

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      namespace: ${{ steps.setup.outputs.namespace }}
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine namespace
        id: setup
        run: |
          if [[ -n "${{ inputs.namespace }}" ]]; then
            NAMESPACE="${{ inputs.namespace }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            NAMESPACE="pr-${{ github.event.pull_request.number }}"
          else
            NAMESPACE="main"
          fi
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT

      - name: Detect changes
        id: changes
        run: |
          BACKEND_CHANGED="false"
          FRONTEND_CHANGED="false"
          
          if [[ "${{ inputs.force_backend }}" == "true" ]]; then
            BACKEND_CHANGED="true"
          elif git diff --name-only origin/main...HEAD 2>/dev/null | grep -q "^backend/"; then
            BACKEND_CHANGED="true"
          fi
          
          if [[ "${{ inputs.force_frontend }}" == "true" ]]; then
            FRONTEND_CHANGED="true"
          elif git diff --name-only origin/main...HEAD 2>/dev/null | grep -q "^frontend/"; then
            FRONTEND_CHANGED="true"
          fi
          
          echo "backend=${BACKEND_CHANGED}" >> $GITHUB_OUTPUT
          echo "frontend=${FRONTEND_CHANGED}" >> $GITHUB_OUTPUT

  push-backend:
    needs: detect
    if: needs.detect.outputs.backend_changed == 'true'
    uses: ./.github/workflows/build.yml
    with:
      component: backend
      namespace: ${{ needs.detect.outputs.namespace }}
      push_image: true
    secrets: inherit

  push-frontend:
    needs: detect
    if: needs.detect.outputs.frontend_changed == 'true'
    uses: ./.github/workflows/build.yml
    with:
      component: frontend
      namespace: ${{ needs.detect.outputs.namespace }}
      push_image: true
    secrets: inherit

  summary:
    needs: [ detect, push-backend, push-frontend ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build summary
        run: |
          echo "## ðŸ“¦ Build and Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`${{ needs.detect.outputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Built**: ${{ needs.detect.outputs.backend_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Built**: ${{ needs.detect.outputs.frontend_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.detect.outputs.backend_changed }}" == "true" ]]; then
            echo "**Backend Image**: \`${{ needs.push-backend.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.detect.outputs.frontend_changed }}" == "true" ]]; then
            echo "**Frontend Image**: \`${{ needs.push-frontend.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Images ready in Azure Container Registry" >> $GITHUB_STEP_SUMMARY
