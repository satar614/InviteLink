name: Manual Deploy & Test Environment

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Kubernetes namespace (will be created if it does not exist)'
        required: true
        type: string
      environment:
        description: 'Environment name (dev, staging, prod, etc.)'
        required: true
        type: string
      backend_image:
        description: 'Backend image tag (default: latest from main)'
        required: false
        type: string
      frontend_image:
        description: 'Frontend image tag (default: latest from main)'
        required: false
        type: string
      run_tests:
        description: 'Run E2E tests after deployment'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  REGISTRY_USERNAME: ${{ secrets.ACR_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.ACR_PASSWORD }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      namespace: ${{ steps.urls.outputs.namespace }}
      backend_url: ${{ steps.urls.outputs.backend_url }}
      frontend_url: ${{ steps.urls.outputs.frontend_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Check if namespace exists
        id: namespace
        run: |
          NAMESPACE="${{ inputs.namespace }}"
          
          if kubectl get namespace "$NAMESPACE" &>/dev/null; then
            echo "namespace_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Namespace '$NAMESPACE' already exists - will update"
          else
            echo "namespace_exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Namespace '$NAMESPACE' does not exist - will create new"
          fi
          
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
          IMAGE_TAG="${{ inputs.backend_image || format('{0}-{1}', github.ref_name, github.sha) }}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Create namespace if needed
        if: steps.namespace.outputs.namespace_exists == 'false'
        run: |
          kubectl create namespace "${{ steps.namespace.outputs.namespace }}"
          echo "âœ… Created namespace: ${{ steps.namespace.outputs.namespace }}"

      - name: Build backend Docker image
        run: |
          docker build \
            --tag ${{ env.REGISTRY_LOGIN_SERVER }}/smartinvite-api:${{ steps.namespace.outputs.image_tag }} \
            --file backend/SmartInvite.Api/SmartInvite.Api/Dockerfile \
            backend/SmartInvite.Api/SmartInvite.Api/

      - name: Push backend image to ACR
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login -u "${{ env.REGISTRY_USERNAME }}" --password-stdin ${{ env.REGISTRY_LOGIN_SERVER }}
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/smartinvite-api:${{ steps.namespace.outputs.image_tag }}
          echo "âœ… Pushed backend image: smartinvite-api:${{ steps.namespace.outputs.image_tag }}"

      - name: Build frontend Docker image
        run: |
          docker build \
            --tag ${{ env.REGISTRY_LOGIN_SERVER }}/invitelink-frontend:${{ steps.namespace.outputs.image_tag }} \
            --file frontend/Dockerfile \
            frontend/

      - name: Push frontend image to ACR
        run: |
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/invitelink-frontend:${{ steps.namespace.outputs.image_tag }}
          echo "âœ… Pushed frontend image: invitelink-frontend:${{ steps.namespace.outputs.image_tag }}"

      - name: Deploy/Update backend with Helm
        run: |
          NAMESPACE="${{ steps.namespace.outputs.namespace }}"
          IMAGE_TAG="${{ steps.namespace.outputs.image_tag }}"
          REGISTRY_URL="${{ env.REGISTRY_LOGIN_SERVER }}"
          
          if [[ "${{ steps.namespace.outputs.namespace_exists }}" == "true" ]]; then
            echo "Updating existing backend deployment..."
            helm upgrade smartinvite-api k8s/charts/backend \
              --namespace "$NAMESPACE" \
              --values k8s/charts/backend/values.yaml \
              --set image.repository="$REGISTRY_URL/smartinvite-api" \
              --set image.tag="$IMAGE_TAG" \
              --wait \
              --timeout 5m
          else
            echo "Installing backend to new namespace..."
            helm install smartinvite-api k8s/charts/backend \
              --namespace "$NAMESPACE" \
              --create-namespace \
              --values k8s/charts/backend/values.yaml \
              --set image.repository="$REGISTRY_URL/smartinvite-api" \
              --set image.tag="$IMAGE_TAG" \
              --wait \
              --timeout 5m
          fi
          
          echo "âœ… Backend deployed to namespace: $NAMESPACE"

      - name: Deploy/Update frontend with Helm
        run: |
          NAMESPACE="${{ steps.namespace.outputs.namespace }}"
          IMAGE_TAG="${{ steps.namespace.outputs.image_tag }}"
          REGISTRY_URL="${{ env.REGISTRY_LOGIN_SERVER }}"
          
          if [[ "${{ steps.namespace.outputs.namespace_exists }}" == "true" ]]; then
            echo "Updating existing frontend deployment..."
            helm upgrade invitelink-frontend k8s/charts/frontend \
              --namespace "$NAMESPACE" \
              --values k8s/charts/frontend/values.yaml \
              --set image.repository="$REGISTRY_URL/invitelink-frontend" \
              --set image.tag="$IMAGE_TAG" \
              --wait \
              --timeout 5m
          else
            echo "Installing frontend to new namespace..."
            helm install invitelink-frontend k8s/charts/frontend \
              --namespace "$NAMESPACE" \
              --create-namespace \
              --values k8s/charts/frontend/values.yaml \
              --set image.repository="$REGISTRY_URL/invitelink-frontend" \
              --set image.tag="$IMAGE_TAG" \
              --wait \
              --timeout 5m
          fi
          
          echo "âœ… Frontend deployed to namespace: $NAMESPACE"

      - name: Wait for services to be ready
        run: |
          NAMESPACE="${{ steps.namespace.outputs.namespace }}"
          echo "Waiting for deployments to be ready in namespace: $NAMESPACE"
          
          kubectl wait --for=condition=available deployment/smartinvite-api -n "$NAMESPACE" --timeout=300s || true
          kubectl wait --for=condition=available deployment/invitelink-frontend -n "$NAMESPACE" --timeout=300s || true
          
          echo "âœ… Deployments are available"

      - name: Get service URLs
        id: urls
        run: |
          NAMESPACE="${{ steps.namespace.outputs.namespace }}"
          
          # Wait for LoadBalancer IPs to be assigned
          echo "Waiting for LoadBalancer IPs..."
          for i in {1..30}; do
            BACKEND_IP=$(kubectl get svc smartinvite-api -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            FRONTEND_IP=$(kubectl get svc invitelink-frontend -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            
            if [ -n "$BACKEND_IP" ] && [ -n "$FRONTEND_IP" ]; then
              break
            fi
            echo "Attempt $i/30: Waiting for IPs..."
            sleep 10
          done
          
          BACKEND_URL="http://${BACKEND_IP}"
          FRONTEND_URL="http://${FRONTEND_IP}"
          
          echo "Backend URL: $BACKEND_URL"
          echo "Frontend URL: $FRONTEND_URL"
          
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT

      - name: Wait for services to be healthy
        run: |
          BACKEND_URL="${{ steps.urls.outputs.backend_url }}"
          FRONTEND_URL="${{ steps.urls.outputs.frontend_url }}"
          
          echo "Checking backend health at $BACKEND_URL..."
          for i in {1..30}; do
            if curl -f -s "${BACKEND_URL}/health" > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
              break
            fi
            echo "Attempt $i/30: Backend not ready yet..."
            sleep 10
          done
          
          echo "Checking frontend health at $FRONTEND_URL..."
          for i in {1..30}; do
            if curl -f -s "${FRONTEND_URL}/health" > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy"
              break
            fi
            echo "Attempt $i/30: Frontend not ready yet..."
            sleep 10
          done

      - name: Generate deployment summary
        id: summary
        run: |
          NAMESPACE="${{ steps.urls.outputs.namespace }}"
          BACKEND_URL="${{ steps.urls.outputs.backend_url }}"
          FRONTEND_URL="${{ steps.urls.outputs.frontend_url }}"
          ACTION="${{ steps.namespace.outputs.namespace_exists == 'true' && 'Updated' || 'Created' }}"
          
          cat > deployment-summary.md << EOF
          ## ðŸš€ Manual Deployment Complete
          
          **Action:** $ACTION
          **Namespace:** \`$NAMESPACE\`
          **Environment:** ${{ inputs.environment }}
          **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ### Service URLs
          - **Backend API:** [$BACKEND_URL]($BACKEND_URL)
          - **Frontend:** [$FRONTEND_URL]($FRONTEND_URL)
          - **Health Check:** [$BACKEND_URL/health]($BACKEND_URL/health)
          
          ### Next Steps
          - Access the frontend at: $FRONTEND_URL
          - API documentation: $BACKEND_URL/swagger
          - Test with E2E suite (see workflow run for details)
          
          **Deployment ID:** ${{ github.run_id }}
          **Triggered by:** ${{ github.actor }}
          EOF
          
          cat deployment-summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload deployment summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-summary-${{ steps.urls.outputs.namespace }}
          path: deployment-summary.md
          retention-days: 30

  test:
    needs: deploy
    runs-on: ubuntu-latest
    if: inputs.run_tests == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore E2E test dependencies
        working-directory: ./tests/InviteLink.E2ETests
        run: dotnet restore

      - name: Build E2E tests
        working-directory: ./tests/InviteLink.E2ETests
        run: dotnet build --no-restore

      - name: Run E2E tests
        id: e2e
        working-directory: ./tests/InviteLink.E2ETests
        env:
          BACKEND_URL: ${{ needs.deploy.outputs.backend_url }}
          FRONTEND_URL: ${{ needs.deploy.outputs.frontend_url }}
        run: |
          dotnet test --no-build --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed" || EXIT_CODE=$?
          
          echo ""
          echo "========================================="
          echo "E2E Test Results"
          echo "========================================="
          echo "Namespace: ${{ needs.deploy.outputs.namespace }}"
          echo "Backend: ${{ needs.deploy.outputs.backend_url }}"
          echo "Frontend: ${{ needs.deploy.outputs.frontend_url }}"
          echo ""
          
          exit ${EXIT_CODE:-0}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ needs.deploy.outputs.namespace }}
          path: |
            tests/InviteLink.E2ETests/TestResults/**/*.trx
            tests/InviteLink.E2ETests/TestResults/**/*.xml
          retention-days: 30

      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Tests Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** \`${{ needs.deploy.outputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Test Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View detailed test results in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
