name: Build & Push Backend
run-name: Build & Push Backend - ${{ github.event.pull_request.title || github.ref_name }}

on:
  push:
  pull_request:
  workflow_call:
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Image tag suffix (optional, defaults to branch/PR info)'
        required: false
        type: string

concurrency:
  group: build-backend
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.image.outputs.uri }}
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.tag_suffix }}" ]]; then
            TAG_SUFFIX="${{ inputs.tag_suffix }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAG_SUFFIX="pr-${{ github.event.pull_request.number }}"
          else
            TAG_SUFFIX="main"
          fi
          IMAGE_TAG="${TAG_SUFFIX}-${{ github.sha }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Build and test backend
        working-directory: ./backend/SmartInvite.Api/SmartInvite.Api
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet test ../../SmartInvite.Api.Tests --configuration Release --logger "trx"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "aa7c9b06-76d3-4dde-976a-48b8166bddb8",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "26105aab-ded4-4e66-a408-309b2e23092c",
              "tenantId": "511f39a2-16cf-4f1a-ac2a-0a45c4b61d37"
            }

      - name: Fetch ACR credentials
        id: acr
        run: |
          # Try to get ACR from resource group first, then subscription-wide
          ACR_LOGIN_SERVER=$(az acr list --resource-group invitelink-rg --query "[0].loginServer" -o tsv 2>/dev/null || true)
          if [[ -z "$ACR_LOGIN_SERVER" ]]; then
            ACR_LOGIN_SERVER=$(az acr list --query "[0].loginServer" -o tsv 2>/dev/null || true)
          fi
          
          # Fallback to hardcoded ACR name if no registry found
          if [[ -z "$ACR_LOGIN_SERVER" ]]; then
            echo "Warning: No ACR found via az acr list, using hardcoded ACR name"
            ACR_LOGIN_SERVER="invitelinkacre9c72f7a.azurecr.io"
          fi
          
          echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "Using ACR: $ACR_LOGIN_SERVER"
          
          # Derive ACR name from login server
          ACR_NAME=${ACR_LOGIN_SERVER%%.azurecr.io}
          echo "ACR Name: $ACR_NAME"
          
          # Fetch credentials
          CREDS_JSON=$(az acr credential show -n "$ACR_NAME" 2>/dev/null || echo '{}')
          ACR_USERNAME=$(echo "$CREDS_JSON" | jq -r '.username // empty')
          ACR_PASSWORD=$(echo "$CREDS_JSON" | jq -r '.passwords[0].value // empty')
          
          if [[ -z "$ACR_USERNAME" || -z "$ACR_PASSWORD" ]]; then
            echo "Error: Could not fetch ACR credentials for $ACR_NAME"
            exit 1
          fi
          
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: image
        run: |
          docker login "${{ steps.acr.outputs.login_server }}" -u "${{ steps.acr.outputs.username }}" -p "${{ steps.acr.outputs.password }}"
          docker build -f ./backend/SmartInvite.Api/SmartInvite.Api/Dockerfile \
            -t ${{ steps.acr.outputs.login_server }}/smartinvite-api:${{ steps.tag.outputs.tag }} \
            ./backend/SmartInvite.Api/SmartInvite.Api
          docker push ${{ steps.acr.outputs.login_server }}/smartinvite-api:${{ steps.tag.outputs.tag }}
          
          IMAGE_URI="${{ steps.acr.outputs.login_server }}/smartinvite-api:${{ steps.tag.outputs.tag }}"
          echo "uri=$IMAGE_URI" >> $GITHUB_OUTPUT

      - name: Push summary
        run: |
          echo "## ðŸ”¨ Backend Build & Push Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ steps.image.outputs.uri }}\`" >> $GITHUB_STEP_SUMMARY
