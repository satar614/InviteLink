name: Build and Push to ACR
run-name: Build and Push to ACR (Backend) - ${{ github.event.pull_request.title || github.ref_name }}

on:
  push:
    branches:
      - main
  pull_request:
  workflow_call:
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Image tag suffix (optional, defaults to branch/PR info)'
        required: false
        type: string

concurrency:
  group: build-backend
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.image.outputs.uri }}
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.tag_suffix }}" ]]; then
            TAG_SUFFIX="${{ inputs.tag_suffix }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAG_SUFFIX="pr-${{ github.event.pull_request.number }}"
          else
            TAG_SUFFIX="main"
          fi
          IMAGE_TAG="${TAG_SUFFIX}-${{ github.sha }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Build and test backend
        working-directory: ./backend/SmartInvite.Api/SmartInvite.Api
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet test ../../SmartInvite.Api.Tests --configuration Release --logger "trx"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "aa7c9b06-76d3-4dde-976a-48b8166bddb8",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "26105aab-ded4-4e66-a408-309b2e23092c",
              "tenantId": "511f39a2-16cf-4f1a-ac2a-0a45c4b61d37"
            }

      - name: Fetch ACR credentials
        id: acr
        run: |
          ACR_LOGIN_SERVER="invitelinkacre9c72f7a.azurecr.io"
          ACR_NAME="invitelinkacre9c72f7a"
          
          echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          
          # Fetch credentials for the ACR
          CREDS_JSON=$(az acr credential show -n "$ACR_NAME")
          ACR_USERNAME=$(echo "$CREDS_JSON" | jq -r '.username')
          ACR_PASSWORD=$(echo "$CREDS_JSON" | jq -r '.passwords[0].value')
          
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: image
        run: |
          LOGIN_SERVER="${{ steps.acr.outputs.login_server }}"
          TAG="${{ steps.tag.outputs.tag }}"
          
          echo "Login Server: $LOGIN_SERVER"
          echo "Tag: $TAG"
          
          docker login "$LOGIN_SERVER" -u "${{ steps.acr.outputs.username }}" -p "${{ steps.acr.outputs.password }}"
          
          IMAGE_TAG="${LOGIN_SERVER}/smartinvite-api:${TAG}"
          echo "Building image: $IMAGE_TAG"
          
          # Build from repo root with Dockerfile path
          docker build -f backend/SmartInvite.Api/SmartInvite.Api/Dockerfile \
            -t "${IMAGE_TAG}" \
            .
          docker push "${IMAGE_TAG}"
          
          echo "uri=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Push summary
        run: |
          echo "## ðŸ”¨ Backend Build & Push Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ steps.image.outputs.uri }}\`" >> $GITHUB_STEP_SUMMARY
