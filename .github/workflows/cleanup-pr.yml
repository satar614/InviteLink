name: Cleanup PR Environment
run-name: Cleanup PR #${{ github.event.pull_request.number }}

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Determine namespace
        id: namespace
        run: |
          NAMESPACE="pr-${{ github.event.pull_request.number }}"
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
          echo "Cleaning up namespace: $NAMESPACE"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "aa7c9b06-76d3-4dde-976a-48b8166bddb8",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "26105aab-ded4-4e66-a408-309b2e23092c",
              "tenantId": "511f39a2-16cf-4f1a-ac2a-0a45c4b61d37"
            }

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group invitelink-rg \
            --name invitelink-aks \
            --overwrite-existing

      - name: Delete namespace
        run: |
          NAMESPACE="${{ steps.namespace.outputs.namespace }}"
          
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Deleting namespace $NAMESPACE and all resources within..."
            kubectl delete namespace "$NAMESPACE"
            echo "Namespace $NAMESPACE deleted"
          else
            echo "Namespace $NAMESPACE does not exist, skipping"
          fi

      - name: Delete ACR images for PR
        run: |
          ACR_NAME="invitelinkacre9c72f7a"
          PR_TAG_PREFIX="pr-${{ github.event.pull_request.number }}-"
          
          # Delete backend images
          echo "Deleting backend images with prefix: $PR_TAG_PREFIX"
          BACKEND_TAGS=$(az acr repository show-tags -n "$ACR_NAME" --repository smartinvite-api \
            --query "[?starts_with(@, '${PR_TAG_PREFIX}')]" -o tsv 2>/dev/null || echo "")
          
          if [[ -n "$BACKEND_TAGS" ]]; then
            echo "$BACKEND_TAGS" | while read tag; do
              echo "Deleting smartinvite-api:$tag"
              az acr repository delete -n "$ACR_NAME" --image smartinvite-api:$tag --yes || true
            done
          else
            echo "No backend images found for PR"
          fi
          
          # Delete frontend images
          echo "Deleting frontend images with prefix: $PR_TAG_PREFIX"
          FRONTEND_TAGS=$(az acr repository show-tags -n "$ACR_NAME" --repository invitelink-frontend \
            --query "[?starts_with(@, '${PR_TAG_PREFIX}')]" -o tsv 2>/dev/null || echo "")
          
          if [[ -n "$FRONTEND_TAGS" ]]; then
            echo "$FRONTEND_TAGS" | while read tag; do
              echo "Deleting invitelink-frontend:$tag"
              az acr repository delete -n "$ACR_NAME" --image invitelink-frontend:$tag --yes || true
            done
          else
            echo "No frontend images found for PR"
          fi

      - name: Cleanup summary
        if: always()
        run: |
          echo "## ðŸ§¹ PR Environment Cleaned Up" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`${{ steps.namespace.outputs.namespace }}\` deleted" >> $GITHUB_STEP_SUMMARY
          echo "**ACR Images**: All \`pr-${{ github.event.pull_request.number }}-*\` tags removed" >> $GITHUB_STEP_SUMMARY
