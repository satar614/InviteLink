name: Deploy Applications
run-name: Deploy Applications - ${{ github.event.pull_request.title || github.ref_name }}

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-apps
  cancel-in-progress: true

jobs:
  build-backend:
    uses: ./.github/workflows/deploy-backend.yml
    secrets: inherit

  build-frontend:
    uses: ./.github/workflows/deploy-frontend.yml
    secrets: inherit

  prepare:
    runs-on: ubuntu-latest
    outputs:
      namespace: ${{ steps.setup.outputs.namespace }}
    steps:
      - name: Determine namespace
        id: setup
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            NAMESPACE="pr-${{ github.event.pull_request.number }}"
          else
            NAMESPACE="main"
          fi
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT

  deploy:
    needs: [build-backend, build-frontend, prepare]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "aa7c9b06-76d3-4dde-976a-48b8166bddb8",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "26105aab-ded4-4e66-a408-309b2e23092c",
              "tenantId": "511f39a2-16cf-4f1a-ac2a-0a45c4b61d37"
            }

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group invitelink-rg \
            --name invitelink-aks \
            --overwrite-existing

      - name: Create namespace
        run: |
          kubectl create namespace ${{ needs.prepare.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Deploy backend with Helm
        run: |
          IMAGE_URI="${{ needs.build-backend.outputs.image_uri }}"
          IMAGE_REPO="${IMAGE_URI%:*}"
          IMAGE_TAG="${IMAGE_URI##*:}"
          helm upgrade --install smartinvite-api ./k8s/charts/backend \
            --namespace ${{ needs.prepare.outputs.namespace }} \
            --set image.repository="$IMAGE_REPO" \
            --set image.tag="$IMAGE_TAG" \
            --wait --timeout 5m

      - name: Deploy frontend with Helm
        run: |
          IMAGE_URI="${{ needs.build-frontend.outputs.image_uri }}"
          IMAGE_REPO="${IMAGE_URI%:*}"
          IMAGE_TAG="${IMAGE_URI##*:}"
          helm upgrade --install invitelink-frontend ./k8s/charts/frontend \
            --namespace ${{ needs.prepare.outputs.namespace }} \
            --set image.repository="$IMAGE_REPO" \
            --set image.tag="$IMAGE_TAG" \
            --wait --timeout 5m

      - name: Get deployment status
        if: always()
        run: |
          echo "=== Namespace: ${{ needs.prepare.outputs.namespace }} ===" 
          kubectl get deployments -n ${{ needs.prepare.outputs.namespace }} || true
          echo ""
          echo "=== Pods ===" 
          kubectl get pods -n ${{ needs.prepare.outputs.namespace }} || true

      - name: Post deployment summary
        if: always()
        run: |
          echo "## âœ… Applications Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`${{ needs.prepare.outputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Image**: \`${{ needs.build-backend.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Image**: \`${{ needs.build-frontend.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
